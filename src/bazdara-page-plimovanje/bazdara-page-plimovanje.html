<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bazdara-import/highcharts-import.html">
<link rel="import" href="../bazdara-import/jquery-import.html">
<link rel="import" href="../styles/shared-styles.html">

<dom-module id="bazdara-page-plimovanje">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>
    <div class="container">

    <h2 class="page-title">Plimovanje morja</h2>
      <paper-material id="plima" elevation="1">
        <div id="graf-plima" style="width:100%;"></div>
      </paper-material>
    </div>
  </template>
  <script>
    Polymer({
      is: 'bazdara-page-plimovanje',

      properties: {
        loading: {
          type: Boolean,
          value: false,
          notify: true
        }
      },

      observers: [
        '_lockScroll(isLoading)'
      ],
      _lockScroll: function(isLoading) {
        if (isLoading) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = 'visible';
        }
      },

      ready: function() {
        // TODO09: Workaround for removed domReady event
        var me = this;
        setTimeout(function() {
          me.domReady();
        }, 1);
      },
      domReady: function() {



        /*global Highcharts */
        /*jshint jquery:true */

        $(function() {

          var masterChart,
            detailChart,
            data, start, end;

          $(document).ready(function() {

            (function() {
              $.ajax({
                url: 'https://x.bazdara.com/plimovanje.php?startDate=2&endDate=7',
                datatype: 'json',
                success: function(resp) {
                  start = resp.start;
                  data = resp.data;
                  end = resp.end;
                  // create master and in its callback, create the detail chart
                  createMaster();
                }
              });
            })();

            // create the master chart
            function createMaster() {
              masterChart = new Highcharts.Chart({
                  chart: {
                    renderTo: 'master-container',
                    reflow: true,
                    borderWidth: 0,
                    backgroundColor: null,
                    marginLeft: 0,
                    marginRight: 0,
                    zoomType: 'x',
                    style: {
                      fontFamily: 'Roboto',
                      color: "#76838f"
                    },
                    shadow: false,
                    events: {
                      // listen to the selection event on the master chart to update the
                      // extremes of the detail chart
                      selection: function(event) {
                        var extremesObject = event.xAxis[0],
                          min = extremesObject.min,
                          max = extremesObject.max,
                          detailData = [],
                          xAxis = this.xAxis[0];

                        // reverse engineer the last part of the data
                        jQuery.each(this.series[0].data, function(i, point) {
                          if (point.x > min && point.x < max) {
                            detailData.push({
                              x: point.x,
                              y: point.y
                            });
                          }
                        });

                        // move the plot bands to reflect the new detail span
                        xAxis.removePlotBand('mask-before');
                        xAxis.addPlotBand({
                          id: 'mask-before',
                          from: Date.UTC(2015, 0, 1),
                          to: min,
                          color: '#e8f1f8'
                        });

                        xAxis.removePlotBand('mask-after');
                        xAxis.addPlotBand({
                          id: 'mask-after',
                          from: max,
                          to: Date.UTC(2025, 12, 31),
                          color: '#e8f1f8'
                        });

                        detailChart.series[0].setData(detailData);

                        return false;
                      }
                    }
                  },
                  title: {
                    text: null
                  },
                  xAxis: {
                    type: 'datetime',
                    showLastTickLabel: true,
                    minorTickInterval: 48 * 60 * 60 * 1000,
                    dateTimeLabelFormats: {
                      day: '%e %b',
                      week: '%e %b %y',
                      month: '%b %y',
                      year: '%Y'
                    },
                    plotBands: [{
                      id: 'mask-before',
                      from: Date.UTC(2015, 0, 1),
                      to: start + 2 * 24 * 60 * 60 * 1000,
                      color: '#e8f1f8'
                    }, {
                      id: 'mask-after',
                      from: start + 3 * 24 * 60 * 60 * 1000,
                      to: Date.UTC(2026, 0, 1),
                      color: '#e8f1f8'
                    }],
                    title: {
                      text: null
                    },
                    lineWidth: 0
                  },
                  yAxis: {
                    gridLineWidth: 1,
                    labels: {
                      enabled: false
                    },
                    title: {
                      text: null
                    },
                    lineWidth: 0,
                    minPadding: 0,
                    maxPadding: 0,
                    minorTickInterval: null,
                    tickLength: null,
                    startOnTick: false,
                    endOnTick: false
                  },
                  tooltip: {
                    formatter: function() {
                      return false;
                    },
                    shared: true,
                    crosshairs: true
                  },

                  legend: {
                    enabled: false
                  },
                  credits: {
                    enabled: false
                  },

                  plotOptions: {
                    series: {
                      color: null,
                      fillColor: {
                        linearGradient: [0, 0, 0, 70],
                        stops: [
                          [0, '#62a8ea'],
                          [1, '#62a8ea']
                        ]
                      },
                      lineWidth: 1,
                      marker: {
                        enabled: false
                      },
                      shadow: false,
                      states: {
                        hover: {
                          lineWidth: 1
                        }
                      },
                      enableMouseTracking: false
                    }
                  },

                  series: [{
                    type: 'area',
                    name: 'height',
                    pointInterval: 10 * 60 * 1000,
                    pointStart: start,
                    data: data
                  }],

                  exporting: {
                    enabled: false
                  }

                },
                function(masterChart) {
                  createDetail(masterChart);
                });
            }

            // create the detail chart
            function createDetail(masterChart) {

              // prepare the detail chart
              var detailData = [],
                detailStart = start + 2 * 24 * 3600 * 1000,
                detailEnd = start + 4 * 24 * 3600 * 1000;

              jQuery.each(masterChart.series[0].data, function(i, point) {
                if (point.x >= detailStart && point.x <= detailEnd) {
                  detailData.push(point.y);
                }
              });

              // create a detail chart referenced by a global variable
              detailChart = new Highcharts.Chart({
                chart: {
                  marginBottom: 110,
                  renderTo: 'detail-container',
                  backgroundColor: null,
                  reflow: true,
                  marginLeft: 0,
                  marginRight: 0,
                  style: {
                    position: 'absolute',
                    fontFamily: 'Roboto',
                    color: "#76838f"

                  }
                },


                credits: {
                  enabled: false,
                },
                title: {
                  text: ''
                },
                xAxis: {
                  type: 'datetime',
                  dateTimeLabelFormats: {
                    day: '%e %b',
                    week: '%e %b %y',
                    month: '%b %y',
                    year: '%Y'
                  },
                  plotLines: [{
                    value: (Date.now() + (120 * 60 * 1000)),
                    color: '#CCC',
                    width: 1,
                    zIndex: 10,
                    dashStyle: 'solid',
                  }]

                },
                yAxis: {
                  title: {
                    text: ''
                  },
                  max: 0.65,
                  min: -0.65,
                  tickInterval: 0.01,
                  plotLines: [

                    {
                      color: '#62a8ea',
                      width: 1,
                      value: 0.60,
                      dashStyle: 'solid',
                      label: {
                        text: 'Plima',
                        style: {
                          fontSize: '10px'
                        }
                      },
                      zIndex: 5
                    }, {
                      color: '#46BE8A',
                      width: 1,
                      value: -0.60,
                      dashStyle: 'solid',
                      label: {
                        text: 'Oseka',
                        style: {
                          fontSize: '10px'
                        }
                      },
                      zIndex: 5
                    },
                  ]
                },
                tooltip: {
                  valueSuffix: 'm',
                  shared: true,
                  crosshairs: true,
                  zIndex: 1
                },
                legend: {
                  enabled: false
                },
                plotOptions: {
                  area: {
                    marker: {
                      enabled: false,
                      states: {
                        hover: {
                          enabled: true,
                          radius: 3
                        }
                      },
                      zIndex: 500
                    },
                    turboThreshold: 2000
                  }
                },
                series: [{
                  name: 'ViÅ¡ina',
                  pointStart: detailStart,
                  pointInterval: 10 * 60 * 1000,
                  data: detailData,
                  type: 'area',
                  color: null,
                  fillColor: {
                    linearGradient: {
                      x1: 0,
                      y1: 0,
                      x2: 0,
                      y2: 1
                    },
                    stops: [
                      [0, '#62a8ea'],
                      [1, '#89bceb']
                    ]
                  }
                }],

                exporting: {
                  enabled: true
                }

              });
            }

            // make the container smaller and add a second container for the master chart
            var $container = $('#graf-plima')
              .css({position: 'relative', width: '100%'});

            var $detailContainer = $('<div id="detail-container">')
              .css({height: '260', width: '100%'})
              .appendTo($container);

            var $masterContainer = $('<div id="master-container">')
              .css({
                position: 'absolute',
                top: 180,
                height: 80,
                width: '100%',
                bottom: 20,
                zIndex: 0
              })
              .appendTo($container);

          });

        });


      }
    });
  </script>
</dom-module>
